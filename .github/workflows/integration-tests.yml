name: Integration Tests

on:
  pull_request:
    branches: [main, development]
  push:
    branches: [main, development]
  schedule:
    # Run daily at 2 AM UTC to catch LiteLLM changes
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      litellm_branch:
        description: 'LiteLLM branch to test against'
        required: false
        default: 'main'

jobs:
  integration-test:
    name: Test with LiteLLM
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix size for faster CI
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'

    steps:
      - name: Checkout Fast LiteLLM
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin pytest pytest-asyncio pytest-json-report

      - name: Build Fast LiteLLM
        run: |
          maturin develop --release

      - name: Setup LiteLLM
        env:
          LITELLM_BRANCH: ${{ github.event.inputs.litellm_branch || 'main' }}
        run: |
          bash scripts/setup_litellm.sh
        shell: bash

      - name: Run integration tests
        run: |
          python scripts/compare_performance.py tests/test_completion.py --skip-baseline
        continue-on-error: true
        id: integration_tests

      - name: Run specific critical tests
        run: |
          bash scripts/run_litellm_tests.sh tests/test_completion.py -v
        shell: bash
        env:
          # Add any required API keys as secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            .litellm/.test_report.json
            .litellm/pytest_report.xml

  compatibility-check:
    name: LiteLLM Compatibility Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        litellm-version: ['latest', 'main']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Fast LiteLLM
        run: |
          pip install maturin
          maturin develop --release

      - name: Install LiteLLM ${{ matrix.litellm-version }}
        run: |
          if [ "${{ matrix.litellm-version }}" = "latest" ]; then
            pip install litellm
          else
            pip install git+https://github.com/BerriAI/litellm.git@${{ matrix.litellm-version }}
          fi

      - name: Test import and basic functionality
        run: |
          python -c "
          import fast_litellm
          import litellm

          print(f'Fast LiteLLM: {fast_litellm.__version__}')
          print(f'LiteLLM: {litellm.__version__}')
          print(f'Rust acceleration: {fast_litellm.RUST_ACCELERATION_AVAILABLE}')

          # Check patch status
          status = fast_litellm.get_patch_status()
          print(f'Patch status: {status}')

          # Basic health check
          health = fast_litellm.health_check()
          print(f'Health check: {health}')

          assert fast_litellm.RUST_ACCELERATION_AVAILABLE, 'Rust acceleration not available'
          print('âœ… Compatibility check passed')
          "

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          pip install maturin pytest pytest-benchmark
          maturin develop --release

      - name: Run benchmarks
        run: |
          pytest tests/benchmark_*.py --benchmark-only --benchmark-json=benchmark.json

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        if: github.ref == 'refs/heads/main'
        with:
          tool: 'pytest'
          output-file-path: benchmark.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.json

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [integration-test, compatibility-check]
    if: always()

    steps:
      - name: Check integration test results
        run: |
          echo "Integration tests completed"
          echo "Check individual job results for details"
